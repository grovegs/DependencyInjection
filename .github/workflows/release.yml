name: üöÄ Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Select the version to increment (major, minor, patch)"
        required: true
        default: "patch"
        type: choice
        options:
          - major
          - minor
          - patch

env:
  PROJECT_OWNER: GroveGames
  PROJECT_NAME: DependencyInjection

jobs:
  calculate_version:
    runs-on: ubuntu-latest

    outputs:
      VERSION: ${{ steps.version_bumper.outputs.NEXT_VERSION }}

    steps:
      - name: üîÑ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîß Version Bumper
        id: version_bumper
        uses: grovegs/actions/.github/actions/bump-version@main
        with:
          version-type: ${{ inputs.version_type }}

  build_core:
    needs: calculate_version

    runs-on: ubuntu-latest

    steps:
      - name: üîÑ Checkout Code
        uses: actions/checkout@v4

      - name: üèóÔ∏è Dotnet Build
        uses: grovegs/actions/.github/actions/build-dotnet@main
        with:
          project: src/$PROJECT_OWNER.$PROJECT_NAME/$PROJECT_OWNER.$PROJECT_NAME.csproj
          version: ${{ needs.calculate_version.outputs.VERSION }}
          configuration: Release

      - name: üì¶ Pack Nuget
        uses: grovegs/actions/.github/actions/pack-nuget@main
        with:
          project: src/$PROJECT_OWNER.$PROJECT_NAME/$PROJECT_OWNER.$PROJECT_NAME.csproj
          version: ${{ needs.calculate_version.outputs.VERSION }}
          configuration: Release
          artifact: $(echo $PROJECT_NAME | sed -E 's/([a-z])([A-Z])/\1_\2/g' | tr '[:upper:]' '[:lower:]')-${{ needs.calculate_version.outputs.VERSION }}

  build_godot:
    needs: calculate_version

    runs-on: ubuntu-latest

    steps:
      - name: üîÑ Checkout Code
        uses: actions/checkout@v4

      - name: üèóÔ∏è Dotnet Build
        uses: grovegs/actions/.github/actions/build-dotnet@main
        with:
          project: src/$PROJECT_OWNER.$PROJECT_NAME.Godot/$PROJECT_OWNER.$PROJECT_NAME.Godot.csproj
          version: ${{ needs.calculate_version.outputs.VERSION }}
          configuration: Release

      - name: üì¶ Pack Nuget
        uses: grovegs/actions/.github/actions/pack-nuget@main
        with:
          project: src/$PROJECT_OWNER.$PROJECT_NAME.Godot/$PROJECT_OWNER.$PROJECT_NAME.Godot.csproj
          version: ${{ needs.calculate_version.outputs.VERSION }}
          configuration: Release
          artifact: $(echo $PROJECT_NAME | sed -E 's/([a-z])([A-Z])/\1_\2/g' | tr '[:upper:]' '[:lower:]')-${{ needs.calculate_version.outputs.VERSION }}-godot

      - name: üéÆ Pack Godot
        uses: grovegs/actions/.github/actions/pack-godot@main
        with:
          addon: src/$PROJECT_OWNER.$PROJECT_NAME.Godot/addons/$PROJECT_OWNER.$PROJECT_NAME
          version: ${{ needs.calculate_version.outputs.VERSION }}
          artifact: $(echo $PROJECT_NAME | sed -E 's/([a-z])([A-Z])/\1_\2/g' | tr '[:upper:]' '[:lower:]')-${{ needs.calculate_version.outputs.VERSION }}-godot-addon

  release_core:
    needs: [calculate_version, build_core]

    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Release Nuget
        uses: grovegs/actions/.github/actions/release-nuget@main
        with:
          artifact: $(echo $PROJECT_NAME | sed -E 's/([a-z])([A-Z])/\1_\2/g' | tr '[:upper:]' '[:lower:]')-${{ needs.calculate_version.outputs.VERSION }}
          api-key: ${{ secrets.NUGET_API_KEY }}

  release_godot:
    needs: [calculate_version, build_godot]

    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Release Nuget
        uses: grovegs/actions/.github/actions/release-nuget@main
        with:
          artifact: $(echo $PROJECT_NAME | sed -E 's/([a-z])([A-Z])/\1_\2/g' | tr '[:upper:]' '[:lower:]')-${{ needs.calculate_version.outputs.VERSION }}-godot
          api-key: ${{ secrets.NUGET_API_KEY }}

  release_github:
    needs: [calculate_version, build_core, build_godot]

    runs-on: ubuntu-latest

    steps:
      - name: üîÑ Checkout Code
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Release Github
        uses: grovegs/actions/.github/actions/release-github@main
        with:
          title: $(echo $PROJECT_NAME | sed -E 's/([a-z])([A-Z])/\1 \2/g') ${{ needs.calculate_version.outputs.VERSION }}
          version: ${{ needs.calculate_version.outputs.VERSION }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
