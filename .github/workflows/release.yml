name: ğŸš€ Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Select the version to increment (major, minor, patch)"
        required: true
        default: patch
        type: choice
        options:
          - major
          - minor
          - patch

env:
  NAME: DependencyInjection
  AUTHORS: GroveGames

jobs:
  calculate_version:
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.bump_version.outputs.NEXT_VERSION }}

    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Bump Version
        id: bump_version
        uses: grovegs/actions/.github/actions/bump-version@main
        with:
          version-type: ${{ inputs.version_type }}

  set_variables:
    needs: calculate_version
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Set Variables
        run: |
          version=${{ needs.calculate_version.outputs.VERSION }}
          artifact=$(echo $name | sed -E 's/([a-z])([A-Z])/\1-\2/g' | tr '[:upper:]' '[:lower:]')-$version
          title="$(echo $name | sed -E 's/([a-z])([A-Z])/\1 \2/g') $version"

          echo VERSION=$version >> $GITHUB_ENV
          echo ARTIFACT=$artifact >> $GITHUB_ENV
          echo TITLE=$title >> $GITHUB_ENV

  build_core:
    needs: set_variables
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Dotnet Build
        uses: grovegs/actions/.github/actions/build-dotnet@main
        with:
          project: src/$AUTHORS.$NAME/$AUTHORS.$NAME.csproj
          version: $VERSION
          configuration: Release

      - name: ğŸ“¦ Pack Nuget
        uses: grovegs/actions/.github/actions/pack-nuget@main
        with:
          project: src/$AUTHORS.$NAME/$AUTHORS.$NAME.csproj
          version: $VERSION
          configuration: Release
          artifact: $ARTIFACT

  build_godot:
    needs: set_variables
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Dotnet Build
        uses: grovegs/actions/.github/actions/build-dotnet@main
        with:
          project: src/$AUTHORS.$NAME.Godot/$AUTHORS.$NAME.Godot.csproj
          version: $VERSION
          configuration: Release

      - name: ğŸ“¦ Pack Nuget
        uses: grovegs/actions/.github/actions/pack-nuget@main
        with:
          project: src/$AUTHORS.$NAME.Godot/$AUTHORS.$NAME.Godot.csproj
          version: $VERSION
          configuration: Release
          artifact: $ARTIFACT-godot

      - name: ğŸ® Pack Godot
        uses: grovegs/actions/.github/actions/pack-godot@main
        with:
          addon: src/$AUTHORS.$NAME.Godot/addons/$AUTHORS.$NAME
          version: $VERSION
          artifact: $ARTIFACT-godot-addon

  release_core:
    needs: build_core
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Release Nuget
        uses: grovegs/actions/.github/actions/release-nuget@main
        with:
          artifact: $ARTIFACT
          api-key: ${{ secrets.NUGET_API_KEY }}

  release_godot:
    needs: build_godot
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Release Nuget
        uses: grovegs/actions/.github/actions/release-nuget@main
        with:
          artifact: $ARTIFACT-godot
          api-key: ${{ secrets.NUGET_API_KEY }}

  release_github:
    needs: [build_core, build_godot]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Release Github
        uses: grovegs/actions/.github/actions/release-github@main
        with:
          title: $TITLE
          version: $VERSION
          github-token: ${{ secrets.GITHUB_TOKEN }}
