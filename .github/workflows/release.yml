name: 🚀 Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Select the version to increment (major, minor, patch)"
        required: true
        default: "patch"
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  calculate_version:
    runs-on: ubuntu-latest

    outputs:
      VERSION: ${{ steps.version_bumper.outputs.NEXT_VERSION }}

    steps:
      - name: 🔄 Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔧 Version Bumper
        id: version_bumper
        uses: grovegs/actions/.github/actions/version-bumper@main
        with:
          version-type: ${{ inputs.version_type }}

  build_core:
    needs: calculate_version

    runs-on: ubuntu-latest

    steps:
      - name: 🔄 Checkout Code
        uses: actions/checkout@v4

      - name: 🏗️ Dotnet Build
        uses: grovegs/actions/.github/actions/dotnet-build@main
        with:
          project: src/GroveGames.DependencyInjection/GroveGames.DependencyInjection.csproj
          version: ${{ needs.calculate_version.outputs.VERSION }}
          configuration: Release

      - name: 📦 Pack Nuget
        uses: grovegs/actions/.github/actions/nuget-pack@main
        with:
          project: src/GroveGames.DependencyInjection/GroveGames.DependencyInjection.csproj
          version: ${{ needs.calculate_version.outputs.VERSION }}
          configuration: Release
          artifact: dependency-injection-${{ needs.calculate_version.outputs.VERSION }}

  build_godot:
    needs: calculate_version

    runs-on: ubuntu-latest

    steps:
      - name: 🔄 Checkout Code
        uses: actions/checkout@v4

      - name: 🏗️ Dotnet Build
        uses: grovegs/actions/.github/actions/dotnet-build@main
        with:
          project: src/GroveGames.DependencyInjection.Godot/GroveGames.DependencyInjection.Godot.csproj
          version: ${{ needs.calculate_version.outputs.VERSION }}
          configuration: Release

      - name: 📦 Pack Nuget
        uses: grovegs/actions/.github/actions/nuget-pack@main
        with:
          project: src/GroveGames.DependencyInjection.Godot/GroveGames.DependencyInjection.Godot.csproj
          version: ${{ needs.calculate_version.outputs.VERSION }}
          configuration: Release
          artifact: dependency-injection-${{ needs.calculate_version.outputs.VERSION }}-godot

      - name: 🎮 Pack Godot
        uses: grovegs/actions/.github/actions/godot-pack@main
        with:
          addon: src/GroveGames.DependencyInjection.Godot/addons/GroveGames.DependencyInjection
          version: ${{ needs.calculate_version.outputs.VERSION }}
          artifact: dependency-injection-${{ needs.calculate_version.outputs.VERSION }}-godot-addon

  release_core:
    needs: [calculate_version, build_core]

    runs-on: ubuntu-latest

    steps:
      - name: 📦 Release Nuget
        uses: grovegs/actions/.github/actions/nuget-release@main
        with:
          artifact: dependency-injection-${{ needs.calculate_version.outputs.VERSION }}
          api-key: ${{ secrets.NUGET_API_KEY }}

  release_godot:
    needs: [calculate_version, build_godot]

    runs-on: ubuntu-latest

    steps:
      - name: 📦 Release Nuget
        uses: grovegs/actions/.github/actions/nuget-release@main
        with:
          artifact: dependency-injection-${{ needs.calculate_version.outputs.VERSION }}-godot
          api-key: ${{ secrets.NUGET_API_KEY }}

  release_github:
    needs: [calculate_version, build_core, build_godot]

    runs-on: ubuntu-latest

    steps:
      - name: 🔄 Checkout Code
        uses: actions/checkout@v4

      - name: 🛠️ Release Github
        uses: grovegs/actions/.github/actions/github-release@main
        with:
          title: Dependency Injection
          version: ${{ needs.calculate_version.outputs.VERSION }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
