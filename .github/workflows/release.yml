name: ðŸš€ Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Select the version to increment (major, minor, patch)"
        required: true
        default: "patch"
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  release:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: GroveGames.DependencyInjection
      PROJECT_NAME: Dependency Injection

    steps:
      - name: ðŸ”„ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”— Set Dynamic Paths
        run: |
          echo "CORE_PROJECT=src/$PROJECT_ID/$PROJECT_ID.csproj" >> $GITHUB_ENV
          echo "GODOT_PROJECT=src/$PROJECT_ID.Godot/$PROJECT_ID.Godot.csproj" >> $GITHUB_ENV
          echo "GODOT_ADDON=src/$PROJECT_ID.Godot/addons/$PROJECT_ID" >> $GITHUB_ENV

      - name: Print Paths
        run: |
          echo "CORE_PROJECT: $CORE_PROJECT"
          echo "GODOT_PROJECT: $GODOT_PROJECT"
          echo "GODOT_ADDON: $GODOT_ADDON"

      - name: ðŸ”– Get Latest Tag
        id: get_tag
        run: |
          git fetch --tags
          latest_tag=$(git tag --sort=-v:refname | head -n 1 || echo "0.0.0")
          echo "latest_tag=${latest_tag:-0.0.0}" >> $GITHUB_OUTPUT

      - name: ðŸ§® Calculate Version
        id: calculate_version
        run: |
          IFS='.' read -r major minor patch <<< "${{ steps.get_tag.outputs.latest_tag }}"
          case "${{ github.event.inputs.version_bump }}" in
            major) major=$((major + 1)); minor=0; patch=0 ;;
            minor) minor=$((minor + 1)); patch=0 ;;
            patch) patch=$((patch + 1)) ;;
          esac
          echo "PROJECT_VERSION=$major.$minor.$patch" >> $GITHUB_ENV
          echo "Calculated Version: $PROJECT_VERSION"

  build_core:
    needs: release
    uses: grovegs/actions/.github/workflows/dotnet-build.yml@main
    with:
      path: $CORE_PROJECT
      version: $PROJECT_VERSION

  build_godot:
    needs: release
    uses: grovegs/actions/.github/workflows/dotnet-build.yml@main
    with:
      path: $GODOT_PROJECT
      version: $PROJECT_VERSION
      platform: godot

  pack_core_nuget:
    needs: build_core
    uses: grovegs/actions/.github/workflows/nuget-pack.yml@main
    with:
      id: $PROJECT_ID
      version: $PROJECT_VERSION

  pack_godot_nuget:
    needs: build_godot
    uses: grovegs/actions/.github/workflows/nuget-pack.yml@main
    with:
      id: $PROJECT_ID.Godot
      version: $PROJECT_VERSION
      platform: godot

  pack_godot_addon:
    needs: release
    uses: grovegs/actions/.github/workflows/godot-pack.yml@main
    with:
      path: $GODOT_ADDON
      id: $PROJECT_ID
      version: $PROJECT_VERSION

  create_release:
    needs:
      - pack_core_nuget
      - pack_godot_nuget
      - pack_godot_addon
    uses: grovegs/actions/.github/workflows/github-release.yml@main
    with:
      title: $PROJECT_NAME $PROJECT_VERSION
      version: $PROJECT_VERSION
      artifacts: godot-addon,nuget-package,nuget-package-godot
