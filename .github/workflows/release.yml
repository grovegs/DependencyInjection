name: üöÄ Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Select the version to increment (major, minor, patch)"
        required: true
        default: patch
        type: choice
        options:
          - major
          - minor
          - patch

env:
  PROJECT_OWNER: GroveGames
  PROJECT_NAME: DependencyInjection

jobs:
  calculate_version:
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.bump_version.outputs.NEXT_VERSION }}

    steps:
      - name: üîÑ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîß Bump Version
        id: bump_version
        uses: grovegs/actions/.github/actions/bump-version@main
        with:
          version-type: ${{ inputs.version_type }}

  set_variables:
    needs: calculate_version
    runs-on: ubuntu-latest
    steps:
      - name: üîÑ Set Variables
        run: |
          to_snake_case() {
            echo $1 | sed -E 's/([a-z])([A-Z])/\1_\2/g' | tr '[:upper:]' '[:lower:]'
          }

          version=${{ needs.calculate_version.outputs.VERSION }}

          artifact_name=$(to_snake_case "$PROJECT_NAME")-$version
          title=$(echo "$PROJECT_NAME" | sed -E 's/([a-z])([A-Z])/\1 \2/g') $version

          echo VERSION=$version >> $GITHUB_ENV
          echo ARTIFACT_NAME=$artifact_name >> $GITHUB_ENV
          echo TITLE=$title >> $GITHUB_ENV

  build_core:
    needs: set_variables
    runs-on: ubuntu-latest
    steps:
      - name: üèóÔ∏è Dotnet Build
        uses: grovegs/actions/.github/actions/build-dotnet@main
        with:
          project: src/$PROJECT_OWNER.$PROJECT_NAME/$PROJECT_OWNER.$PROJECT_NAME.csproj
          version: $VERSION
          configuration: Release

      - name: üì¶ Pack Nuget
        uses: grovegs/actions/.github/actions/pack-nuget@main
        with:
          project: src/$PROJECT_OWNER.$PROJECT_NAME/$PROJECT_OWNER.$PROJECT_NAME.csproj
          version: $VERSION
          configuration: Release
          artifact: $ARTIFACT_NAME

  build_godot:
    needs: set_variables
    runs-on: ubuntu-latest
    steps:
      - name: üèóÔ∏è Dotnet Build
        uses: grovegs/actions/.github/actions/build-dotnet@main
        with:
          project: src/$PROJECT_OWNER.$PROJECT_NAME.Godot/$PROJECT_OWNER.$PROJECT_NAME.Godot.csproj
          version: $VERSION
          configuration: Release

      - name: üì¶ Pack Nuget
        uses: grovegs/actions/.github/actions/pack-nuget@main
        with:
          project: src/$PROJECT_OWNER.$PROJECT_NAME.Godot/$PROJECT_OWNER.$PROJECT_NAME.Godot.csproj
          version: $VERSION
          configuration: Release
          artifact: $ARTIFACT_NAME-godot

      - name: üéÆ Pack Godot
        uses: grovegs/actions/.github/actions/pack-godot@main
        with:
          addon: src/$PROJECT_OWNER.$PROJECT_NAME.Godot/addons/$PROJECT_OWNER.$PROJECT_NAME
          version: $VERSION
          artifact: $ARTIFACT_NAME-godot-addon

  release_core:
    needs: build_core
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Release Nuget
        uses: grovegs/actions/.github/actions/release-nuget@main
        with:
          artifact: $ARTIFACT_NAME
          api-key: ${{ secrets.NUGET_API_KEY }}

  release_godot:
    needs: build_godot
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Release Nuget
        uses: grovegs/actions/.github/actions/release-nuget@main
        with:
          artifact: $ARTIFACT_NAME-godot
          api-key: ${{ secrets.NUGET_API_KEY }}

  release_github:
    needs: [build_core, build_godot]
    runs-on: ubuntu-latest
    steps:
      - name: üõ†Ô∏è Release Github
        uses: grovegs/actions/.github/actions/release-github@main
        with:
          title: $TITLE
          version: $VERSION
          github-token: ${{ secrets.GITHUB_TOKEN }}
