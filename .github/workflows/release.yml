name: ğŸš€ Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Select the version to increment (major, minor, patch)"
        required: true
        default: patch
        type: choice
        options:
          - major
          - minor
          - patch

env:
  NAME: DependencyInjection
  AUTHOR: GroveGames

jobs:
  calculate_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump_version.outputs.next_version }}

    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Bump Version
        id: bump_version
        uses: grovegs/actions/.github/actions/bump-version@main
        with:
          version-type: ${{ inputs.version_type }}

  set_metadata:
    needs: calculate_version
    runs-on: ubuntu-latest
    outputs:
      title: ${{ steps.generate_title.outputs.artifact }}
      artifact: ${{ steps.generate_artifact.outputs.artifact }}
      version: ${{ needs.calculate_version.outputs.version }}

    steps:
      - name: ğŸ“ Generate Title
        id: generate_title
        run: |
          title="$(echo $name | sed -E 's/([a-z])([A-Z])/\1 \2/g') ${{ needs.calculate_version.outputs.version }}"
          echo title=$title >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Generate Artifact
        id: generate_artifact
        run: |
          artifact=$(echo $name | sed -E 's/([a-z])([A-Z])/\1-\2/g' | tr '[:upper:]' '[:lower:]')-${{ needs.calculate_version.outputs.version }}
          echo artifact=$artifact >> $GITHUB_OUTPUT

  build_core:
    needs: set_metadata
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Dotnet Build
        uses: grovegs/actions/.github/actions/build-dotnet@main
        with:
          project: src/$AUTHOR.$NAME/$AUTHOR.$NAME.csproj
          version: ${{ needs.set_metadata.outputs.version }}
          configuration: Release

      - name: ğŸ“¦ Pack Nuget
        uses: grovegs/actions/.github/actions/pack-nuget@main
        with:
          project: src/$AUTHOR.$NAME/$AUTHOR.$NAME.csproj
          version: ${{ needs.set_metadata.outputs.version }}
          configuration: Release
          artifact: ${{ needs.set_metadata.outputs.artifact }}

  build_godot:
    needs: set_metadata
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Dotnet Build
        uses: grovegs/actions/.github/actions/build-dotnet@main
        with:
          project: src/$AUTHOR.$NAME.Godot/$AUTHOR.$NAME.Godot.csproj
          version: ${{ needs.set_metadata.outputs.version }}
          configuration: Release

      - name: ğŸ“¦ Pack Nuget
        uses: grovegs/actions/.github/actions/pack-nuget@main
        with:
          project: src/$AUTHOR.$NAME.Godot/$AUTHOR.$NAME.Godot.csproj
          version: ${{ needs.set_metadata.outputs.version }}
          configuration: Release
          artifact: ${{ needs.set_metadata.outputs.artifact }}-godot

      - name: ğŸ® Pack Godot
        uses: grovegs/actions/.github/actions/pack-godot@main
        with:
          addon: src/$AUTHOR.$NAME.Godot/addons/$AUTHOR.$NAME
          version: ${{ needs.set_metadata.outputs.version }}
          artifact: ${{ needs.set_metadata.outputs.artifact }}-godot-addon

  release_core:
    needs: [set_metadata, build_core]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Release Nuget
        uses: grovegs/actions/.github/actions/release-nuget@main
        with:
          artifact: ${{ needs.set_metadata.outputs.artifact }}
          api-key: ${{ secrets.NUGET_API_KEY }}

  release_godot:
    needs: [set_metadata, build_godot]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Release Nuget
        uses: grovegs/actions/.github/actions/release-nuget@main
        with:
          artifact: ${{ needs.set_metadata.outputs.artifact }}-godot
          api-key: ${{ secrets.NUGET_API_KEY }}

  release_github:
    needs: [set_metadata, build_core, build_godot]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Release Github
        uses: grovegs/actions/.github/actions/release-github@main
        with:
          title: $TITLE
          version: ${{ needs.set_metadata.outputs.version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
