name: ðŸš€ Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Select the version to increment (major, minor, patch)"
        required: true
        default: "patch"
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  calculate_version:
    runs-on: ubuntu-latest

    outputs:
      PROJECT_VERSION: ${{ steps.calculate_version.outputs.version }}

    steps:
      - name: ðŸ”„ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”– Get Latest Tag
        id: get_tag
        run: |
          git fetch --tags
          latest_tag=$(git tag --sort=-v:refname | head -n 1 || echo "0.0.0")
          echo "latest_tag=${latest_tag:-0.0.0}" >> $GITHUB_OUTPUT

      - name: ðŸ§® Calculate Version
        id: calculate_version
        run: |
          IFS='.' read -r major minor patch <<< "${{ steps.get_tag.outputs.latest_tag }}"
          case "${{ github.event.inputs.version_bump }}" in
            major) major=$((major + 1)); minor=0; patch=0 ;;
            minor) minor=$((minor + 1)); patch=0 ;;
            patch) patch=$((patch + 1)) ;;
          esac
          VERSION="$major.$minor.$patch"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Calculated Version: $VERSION"

  build_core:
    needs: calculate_version
    uses: grovegs/actions/.github/workflows/dotnet-build.yml@main
    with:
      source: src/GroveGames.DependencyInjection
      id: GroveGames.DependencyInjection
      version: ${{ needs.calculate_version.outputs.PROJECT_VERSION }}

  build_godot:
    needs: calculate_version
    uses: grovegs/actions/.github/workflows/dotnet-build.yml@main
    with:
      source: src/GroveGames.DependencyInjection.Godot
      id: GroveGames.DependencyInjection.Godot
      version: ${{ needs.calculate_version.outputs.PROJECT_VERSION }}
      platform: godot

  pack_core_nuget:
    needs: [calculate_version, build_core]
    uses: grovegs/actions/.github/workflows/nuget-pack.yml@main
    with:
      name: dependency-injection
      source: src/GroveGames.DependencyInjection
      id: GroveGames.DependencyInjection
      version: ${{ needs.calculate_version.outputs.PROJECT_VERSION }}

  pack_godot_nuget:
    needs: [calculate_version, build_godot]
    uses: grovegs/actions/.github/workflows/nuget-pack.yml@main
    with:
      name: dependency-injection
      source: src/GroveGames.DependencyInjection.Godot
      id: GroveGames.DependencyInjection.Godot
      version: ${{ needs.calculate_version.outputs.PROJECT_VERSION }}
      platform: godot

  pack_godot_addon:
    needs: calculate_version
    uses: grovegs/actions/.github/workflows/godot-pack.yml@main
    with:
      name: dependency-injection
      source: src/GroveGames.DependencyInjection.Godot/addons
      id: GroveGames.DependencyInjection
      version: ${{ needs.calculate_version.outputs.PROJECT_VERSION }}

  create_release:
    needs:
      [calculate_version, pack_core_nuget, pack_godot_nuget, pack_godot_addon]
    uses: grovegs/actions/.github/workflows/github-release.yml@main
    with:
      title: "Dependency Injection ${{ needs.calculate_version.outputs.PROJECT_VERSION }}"
      version: ${{ needs.calculate_version.outputs.PROJECT_VERSION }}
      artifacts: godot-addon,nuget-package,nuget-package-godot
