name: üöÄ Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Select the version to increment (major, minor, patch)"
        required: true
        default: "patch"
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  release:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: GroveGames.DependencyInjection
      PROJECT_NAME: Dependency Injection

    steps:
      - name: üîÑ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîó Set Dynamic Paths
        run: |
          echo "CORE_PROJECT=src/$PROJECT_ID/$PROJECT_ID.csproj" >> $GITHUB_ENV
          echo "GODOT_PROJECT=src/$PROJECT_ID.Godot/$PROJECT_ID.Godot.csproj" >> $GITHUB_ENV
          echo "GODOT_ADDON=src/$PROJECT_ID.Godot/addons/$PROJECT_ID" >> $GITHUB_ENV

      - name: üîñ Get Latest Tag
        id: get_tag
        run: |
          git fetch --tags
          latest_tag=$(git tag --sort=-v:refname | head -n 1 || echo "0.0.0")
          echo "latest_tag=${latest_tag:-0.0.0}" >> $GITHUB_OUTPUT

      - name: üßÆ Calculate Version
        id: calculate_version
        run: |
          IFS='.' read -r major minor patch <<< "${{ steps.get_tag.outputs.latest_tag }}"
          case "${{ github.event.inputs.version_bump }}" in
            major) major=$((major + 1)); minor=0; patch=0 ;;
            minor) minor=$((minor + 1)); patch=0 ;;
            patch) patch=$((patch + 1)) ;;
          esac
          echo "PROJECT_VERSION=$major.$minor.$patch" >> $GITHUB_ENV

  build_core:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: üèóÔ∏è Build Core Project
        uses: grovegs/actions/.github/workflows/dotnet-build.yml@main
        with:
          path: $CORE_PROJECT
          version: $PROJECT_VERSION

  build_godot:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: üèóÔ∏è Build Godot Project
        uses: grovegs/actions/.github/workflows/dotnet-build.yml@main
        with:
          path: $GODOT_PROJECT
          version: $PROJECT_VERSION
          platform: godot

  pack_core_nuget:
    needs: build_core
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Pack Core NuGet Package
        uses: grovegs/actions/.github/workflows/nuget-pack.yml@main
        with:
          id: $PROJECT_ID
          version: $PROJECT_VERSION

  pack_godot_nuget:
    needs: build_godot
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Pack Godot NuGet Package
        uses: grovegs/actions/.github/workflows/nuget-pack.yml@main
        with:
          id: $PROJECT_ID.Godot
          version: $PROJECT_VERSION
          platform: godot

  pack_godot_addon:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Pack Godot Addon
        uses: grovegs/actions/.github/workflows/godot-pack.yml@main
        with:
          path: $GODOT_ADDON
          id: $PROJECT_ID
          version: $PROJECT_VERSION

  create_release:
    needs:
      - pack_core_nuget
      - pack_godot_nuget
      - pack_godot_addon
    runs-on: ubuntu-latest
    steps:
      - name: üìù Create GitHub Release
        uses: grovegs/actions/.github/workflows/github-release.yml@main
        with:
          title: $PROJECT_NAME $PROJECT_VERSION
          version: $PROJECT_VERSION
          artifacts: godot-addon,nuget-package,nuget-package-godot
